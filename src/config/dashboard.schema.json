{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "dashboard.schema.json",
  "title": "GeoAnalyzr Dashboard Schema",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "dashboard"],
  "properties": {
    "$schema": { "type": "string" },
    "schemaVersion": { "type": "string", "pattern": "^0\\.1\\.0$" },
    "dashboard": { "$ref": "#/$defs/dashboardDef" }
  },
  "$defs": {
    "id": { "type": "string", "pattern": "^[a-z0-9_\\-]{3,64}$" },
    "title": { "type": "string", "minLength": 1 },
    "grain": { "enum": ["session", "game", "round"] },
    "chartType": { "enum": ["bar", "line"] },

    "placementDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": { "type": "integer", "minimum": 0 },
        "y": { "type": "integer", "minimum": 0 },
        "w": { "type": "integer", "minimum": 1 },
        "h": { "type": "integer", "minimum": 1 }
      }
    },

    "dashboardDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "sections"],
      "properties": {
        "id": { "$ref": "#/$defs/id" },
        "title": { "$ref": "#/$defs/title" },
        "sections": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/sectionDef" }
        }
      }
    },

    "sectionDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "layout"],
      "properties": {
        "id": { "$ref": "#/$defs/id" },
        "title": { "$ref": "#/$defs/title" },
        "layout": { "$ref": "#/$defs/layoutDef" }
      }
    },

    "layoutDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "columns", "cards"],
      "properties": {
        "mode": { "enum": ["grid"] },
        "columns": { "type": "integer", "minimum": 1, "maximum": 48 },
        "cards": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/cardPlacementDef" }
        }
      }
    },

    "cardPlacementDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["cardId", "title", "x", "y", "w", "h", "card"],
      "properties": {
        "cardId": { "$ref": "#/$defs/id" },
        "title": { "$ref": "#/$defs/title" },
        "x": { "type": "integer", "minimum": 0 },
        "y": { "type": "integer", "minimum": 0 },
        "w": { "type": "integer", "minimum": 1 },
        "h": { "type": "integer", "minimum": 1 },
        "card": { "$ref": "#/$defs/cardDef" }
      }
    },

    "cardDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "children"],
      "properties": {
        "type": { "const": "composite" },
        "children": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/widgetDef" }
        }
      }
    },

    "widgetDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["widgetId", "type", "title", "grain", "spec"],
      "properties": {
        "widgetId": { "$ref": "#/$defs/id" },
        "type": { "enum": ["chart", "stat_list", "stat_value", "breakdown", "record_list"] },
        "title": { "$ref": "#/$defs/title" },
        "grain": { "$ref": "#/$defs/grain" },
        "placement": { "$ref": "#/$defs/placementDef" },
        "spec": {}
      },
      "allOf": [
        { "if": { "properties": { "type": { "const": "chart" } } }, "then": { "properties": { "spec": { "$ref": "#/$defs/chartSpecDef" } } } },
        { "if": { "properties": { "type": { "const": "stat_list" } } }, "then": { "properties": { "spec": { "$ref": "#/$defs/statListSpecDef" } } } },
        { "if": { "properties": { "type": { "const": "stat_value" } } }, "then": { "properties": { "spec": { "$ref": "#/$defs/statValueSpecDef" } } } },
        { "if": { "properties": { "type": { "const": "breakdown" } } }, "then": { "properties": { "spec": { "$ref": "#/$defs/breakdownSpecDef" } } } },
        { "if": { "properties": { "type": { "const": "record_list" } } }, "then": { "properties": { "spec": { "$ref": "#/$defs/recordListSpecDef" } } } }
      ]
    },

    "filterDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dimension", "op"],
      "properties": {
        "dimension": { "type": "string", "minLength": 1 },
        "op": { "enum": ["eq", "neq", "in", "nin"] },
        "value": {},
        "values": { "type": "array", "items": {} }
      },
      "allOf": [
        { "if": { "properties": { "op": { "const": "in" } } }, "then": { "required": ["values"] } },
        { "if": { "properties": { "op": { "const": "nin" } } }, "then": { "required": ["values"] } },
        { "if": { "properties": { "op": { "const": "eq" } } }, "then": { "required": ["value"] } },
        { "if": { "properties": { "op": { "const": "neq" } } }, "then": { "required": ["value"] } }
      ]
    },

    "selectorDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": {
        "mode": { "enum": ["all", "top_n", "selected"] },
        "maxSeries": { "type": "integer", "minimum": 1, "maximum": 200 },
        "n": { "type": "integer", "minimum": 1, "maximum": 200 },
        "values": {
          "type": "array",
          "minItems": 1,
          "maxItems": 200,
          "items": { "type": "string", "minLength": 1 }
        }
      },
      "allOf": [
        { "if": { "properties": { "mode": { "const": "top_n" } } }, "then": { "required": ["n"] } },
        { "if": { "properties": { "mode": { "const": "selected" } } }, "then": { "required": ["values"] } }
      ]
    },

    "sortDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": { "mode": { "enum": ["chronological", "asc", "desc"] } }
    },

    "actionsDef": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hover": { "type": "boolean" },
        "click": { "$ref": "#/$defs/clickActionDef" }
      }
    },

    "clickActionDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "target", "columnsPreset"],
      "properties": {
        "type": { "enum": ["drilldown"] },
        "target": { "enum": ["rounds", "games", "sessions", "players"] },
        "columnsPreset": { "type": "string", "minLength": 1 },
        "filterFromPoint": { "type": "boolean" },
        "extraFilters": {
          "type": "array",
          "items": { "$ref": "#/$defs/filterDef" }
        }
      }
    },

    "chartSpecDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "x", "y"],
      "properties": {
        "type": { "$ref": "#/$defs/chartType" },
        "x": { "$ref": "#/$defs/xAxisDef" },
        "y": { "$ref": "#/$defs/yAxisDef" },
        "series": { "$ref": "#/$defs/seriesDef" },
        "sort": { "$ref": "#/$defs/sortDef" },
        "actions": { "$ref": "#/$defs/actionsDef" }
      }
    },

    "xAxisDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dimension"],
      "properties": {
        "dimension": { "type": "string", "minLength": 1 },
        "selector": { "$ref": "#/$defs/selectorDef" }
      }
    },

    "yAxisDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["measure"],
      "properties": { "measure": { "type": "string", "minLength": 1 } }
    },

    "seriesDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dimension", "selector"],
      "properties": {
        "dimension": { "type": "string", "minLength": 1 },
        "selector": { "$ref": "#/$defs/selectorDef" }
      }
    },

    "statListSpecDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["rows"],
      "properties": {
        "rows": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/statRowDef" }
        }
      }
    },

    "statRowDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["label", "measure"],
      "properties": {
        "label": { "$ref": "#/$defs/title" },
        "measure": { "type": "string", "minLength": 1 },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/filterDef" } },
        "actions": { "$ref": "#/$defs/actionsDef" }
      }
    },

    "statValueSpecDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["label", "measure"],
      "properties": {
        "label": { "$ref": "#/$defs/title" },
        "measure": { "type": "string", "minLength": 1 },
        "actions": { "$ref": "#/$defs/actionsDef" }
      }
    },

    "breakdownSpecDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dimension", "measure"],
      "properties": {
        "dimension": { "type": "string", "minLength": 1 },
        "measure": { "type": "string", "minLength": 1 },
        "sort": { "$ref": "#/$defs/sortDef" },
        "limit": { "type": "integer", "minimum": 1, "maximum": 200 },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/filterDef" } },
        "actions": { "$ref": "#/$defs/actionsDef" }
      }
    },

    "recordListSpecDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["records"],
      "properties": {
        "records": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/recordDef" }
        }
      }
    },

    "recordDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "label", "metric", "groupBy", "extreme"],
      "properties": {
        "id": { "$ref": "#/$defs/id" },
        "label": { "$ref": "#/$defs/title" },
        "metric": { "type": "string", "minLength": 1 },
        "groupBy": { "type": "string", "minLength": 1 },
        "extreme": { "enum": ["max", "min"] }
      }
    }
  }
}
