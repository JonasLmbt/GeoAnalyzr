{
  "$schema": "./semantic.schema.json",
  "schemaVersion": "0.1.0",

  "grains": ["session", "game", "round"],

  "datasets": {
    "session": {
      "primaryKey": ["sessionId"],
      "timeField": "sessionStartTs"
    },
    "game": {
      "primaryKey": ["gameId"],
      "timeField": "ts"
    },
    "round": {
      "primaryKey": ["gameId", "roundNumber"],
      "timeField": "ts"
    }
  },

  "settings": {
    "sessionGapMinutesDefault": 45
  },

    "dimensions": {
      "time_day": {
        "label": "Date",
        "kind": "time",
        "grain": ["round", "game"],
        "ordered": true,
        "allowedCharts": ["line", "bar"],
        "sortModes": ["chronological"]
      },
      "weekday": {
        "label": "Weekday",
        "kind": "category",
        "grain": ["round", "game"],
        "ordered": true,
        "allowedCharts": ["bar"],
        "sortModes": ["chronological", "asc", "desc"]
      },
      "hour": {
        "label": "Hour of day",
        "kind": "category",
        "grain": ["round", "game"],
        "ordered": true,
        "allowedCharts": ["bar"],
        "sortModes": ["chronological", "asc", "desc"]
      },
    "session_index": {
      "label": "Session #",
      "kind": "category",
      "grain": "session",
      "ordered": true,
      "allowedCharts": ["bar", "line"],
      "sortModes": ["chronological", "asc", "desc"]
    },
    "session_start": {
      "label": "Session start",
      "kind": "category",
      "grain": "session",
      "ordered": true,
      "allowedCharts": ["bar", "line"],
      "sortModes": ["chronological", "asc", "desc"]
    },
    "game_mode": {
      "label": "Game mode",
      "kind": "category",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 10 }
    },
    "mode_family": {
      "label": "Mode",
      "kind": "category",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 10 }
    },
    "result": {
      "label": "Result",
      "kind": "category",
      "grain": "game",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 5 }
    },

    "round_number": {
      "label": "Round #",
      "kind": "category",
      "grain": "round",
      "ordered": true,
      "allowedCharts": ["bar"],
      "sortModes": ["chronological"]
    },
    "round_id": {
      "label": "Round",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "large", "maxSeries": 200, "selectorRequired": true }
    },
    "true_country": {
      "label": "True country",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "large", "maxSeries": 12, "selectorRequired": true }
    },
    "teammate_name": {
      "label": "Teammate",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "large", "maxSeries": 15, "selectorRequired": true }
    },
    "movement_type": {
      "label": "Movement",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 8 }
    },
    "game_id": {
      "label": "Game",
      "kind": "category",
      "grain": ["round", "game"],
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "large", "maxSeries": 50, "selectorRequired": true }
    },
    "is_hit": {
      "label": "Hit?",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 2 }
    },
    "is_throw": {
      "label": "Throw?",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 2 }
    },
    "is_near_perfect": {
      "label": "Near-perfect? (>=4500)",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 2 }
    },
    "is_low_score": {
      "label": "Low score? (<500)",
      "kind": "category",
      "grain": "round",
      "allowedCharts": ["bar"],
      "sortModes": ["asc", "desc"],
      "cardinality": { "policy": "small", "maxSeries": 2 }
    },
    "duration_bucket": {
      "label": "Guess duration bucket",
      "kind": "category",
      "grain": "round",
      "ordered": true,
      "allowedCharts": ["bar"],
      "sortModes": ["chronological", "asc", "desc"]
    },
    "score_bucket": {
      "label": "Score bucket",
      "kind": "category",
      "grain": "round",
      "ordered": true,
      "allowedCharts": ["bar"],
      "sortModes": ["chronological"]
    }
  },

  "measures": {
    "games_count": {
      "label": "Games",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_games"
    },
    "rounds_count": {
      "label": "Rounds",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_rounds"
    },

    "avg_score": {
      "label": "Avg score",
      "unit": "points",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_player_self_score",
      "range": { "min": 0, "max": 5000 }
    },
    "avg_score_hit_only": {
      "label": "Avg score (hit only)",
      "unit": "points",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_player_self_score_hit_only",
      "range": { "min": 0, "max": 5000 }
    },
    "avg_distance_km": {
      "label": "Avg distance",
      "unit": "km",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_player_self_distance_km"
    },
    "avg_guess_duration": {
      "label": "Avg guess duration",
      "unit": "seconds",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_duration_seconds"
    },
    "fivek_rate": {
      "label": "5k rate",
      "unit": "percent",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "rate_player_self_score_eq_5000"
    },
    "fivek_count": {
      "label": "5k count",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_5k_round"
    },
    "near_perfect_rate": {
      "label": "Near-perfect rate (>=4500)",
      "unit": "percent",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "rate_near_perfect_round"
    },
    "near_perfect_count": {
      "label": "Near-perfect count (>=4500)",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_near_perfect_round"
    },
    "low_score_rate": {
      "label": "Low score rate (<500)",
      "unit": "percent",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "rate_low_score_round"
    },
    "low_score_count": {
      "label": "Low score count (<500)",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_low_score_round"
    },

    "win_rate": {
      "label": "Win rate",
      "unit": "percent",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "rate_player_self_win"
    },
    "win_count": {
      "label": "Win count",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_win_game"
    },
    "games_with_result_count": {
      "label": "Games with result data",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_games_with_result"
    },
    "loss_count": {
      "label": "Loss count",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_loss_game"
    },
    "tie_count": {
      "label": "Tie count",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_tie_game"
    },
    "end_rating_avg": {
      "label": "Avg end rating",
      "unit": "rating",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_player_self_end_rating"
    },
    "best_end_rating": {
      "label": "Best rating",
      "unit": "rating",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "max_player_self_end_rating"
    },
    "rating_delta_avg": {
      "label": "Avg rating delta",
      "unit": "rating",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_player_self_rating_delta"
    },
    "longest_win_streak": {
      "label": "Longest win streak",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "max_win_streak"
    },
    "longest_loss_streak": {
      "label": "Longest loss streak",
      "unit": "count",
      "grain": "game",
      "allowedCharts": ["bar", "line"],
      "formulaId": "max_loss_streak"
    },

    "hit_rate": {
      "label": "Hit rate",
      "unit": "percent",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "rate_true_country_hit"
    },
    "hit_count": {
      "label": "Hit count",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_hit_round"
    },
    "throw_rate": {
      "label": "Throw rate",
      "unit": "percent",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "rate_throw_round"
    },
    "throw_count": {
      "label": "Throw count",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_throw_round"
    },
    "score_median": {
      "label": "Median score",
      "unit": "points",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "median_player_self_score",
      "range": { "min": 0, "max": 5000 }
    },
    "score_stddev": {
      "label": "Score Std Dev",
      "unit": "points",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "stddev_player_self_score",
      "range": { "min": 0, "max": 5000 }
    },
    "distance_median_km": {
      "label": "Median distance",
      "unit": "km",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "median_player_self_distance_km"
    },
    "guess_duration_median": {
      "label": "Median guess duration",
      "unit": "seconds",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "median_duration_seconds"
    },
    "rounds_with_time_count": {
      "label": "Rounds with time data",
      "unit": "count",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_rounds_with_duration"
    },
    "time_played_seconds": {
      "label": "Time played",
      "unit": "duration",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "sum_duration_seconds"
    },

    "damage_dealt_avg": {
      "label": "Avg damage dealt",
      "unit": "points",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_damage_dealt"
    },
    "damage_taken_avg": {
      "label": "Avg damage taken",
      "unit": "points",
      "grain": "round",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_damage_taken"
    }
    ,
    "sessions_count": {
      "label": "Sessions",
      "unit": "count",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "count_sessions"
    },
    "sessions_longest_break_seconds": {
      "label": "Longest break between sessions",
      "unit": "duration",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "max_break_between_sessions_seconds"
    },
    "sessions_avg_games": {
      "label": "Avg games per session",
      "unit": "float",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "mean_games_per_session"
    },
    "session_games_count": {
      "label": "Games",
      "unit": "count",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_games_count"
    },
    "session_rounds_count": {
      "label": "Rounds",
      "unit": "count",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_rounds_count"
    },
    "session_avg_score": {
      "label": "Avg score",
      "unit": "points",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_avg_score",
      "range": { "min": 0, "max": 5000 }
    },
    "session_avg_guess_duration": {
      "label": "Avg guess duration",
      "unit": "seconds",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_avg_guess_duration"
    },
    "session_avg_distance_km": {
      "label": "Avg distance",
      "unit": "km",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_avg_distance_km"
    },
    "session_fivek_rate": {
      "label": "5k rate",
      "unit": "percent",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_fivek_rate"
    },
    "session_hit_rate": {
      "label": "Hit rate",
      "unit": "percent",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_hit_rate"
    },
    "session_throw_rate": {
      "label": "Throw rate",
      "unit": "percent",
      "grain": "session",
      "allowedCharts": ["bar", "line"],
      "formulaId": "session_throw_rate"
    }
  },

  "units": {
    "count": { "format": "int" },
    "points": { "format": "float", "decimals": 1 },
    "percent": { "format": "percent", "decimals": 1 },
    "seconds": { "format": "float", "decimals": 1 },
    "duration": { "format": "duration" },
    "rating": { "format": "float", "decimals": 0 },
    "km": { "format": "float", "decimals": 1 },
    "float": { "format": "float", "decimals": 2 }
  },
  "columnAliases": {
    "ts": ["playedAt", "startTime"],
    "true_country": ["trueCountry", "true_country"],
    "player_self_country": ["player_self_guessCountry", "p1_guessCountry", "guessCountry"],
    "player_self_score": ["player_self_score", "p1_score", "score"],
    "player_self_guessLat": ["p1_guessLat", "player_self_guessLat"],
    "player_self_guessLng": ["p1_guessLng", "player_self_guessLng"],
    "player_self_isBestGuess": ["p1_isBestGuess", "player_self_isBestGuess"],
    "player_mate_guessLat": ["p2_guessLat", "player_mate_guessLat"],
    "player_mate_guessLng": ["p2_guessLng", "player_mate_guessLng"],
    "player_mate_score": ["p2_score", "player_mate_score"],
    "player_mate_isBestGuess": ["p2_isBestGuess", "player_mate_isBestGuess"],
    "player_opponent_guessLat": ["p3_guessLat", "player_opponent_guessLat", "p2_guessLat"],
    "player_opponent_guessLng": ["p3_guessLng", "player_opponent_guessLng", "p2_guessLng"],
    "player_opponent_score": ["p3_score", "player_opponent_score", "p2_score"],
    "player_opponent_isBestGuess": ["p3_isBestGuess", "player_opponent_isBestGuess", "p2_isBestGuess"],
    "player_opponent_mate_guessLat": ["p4_guessLat", "player_opponent_mate_guessLat"],
    "player_opponent_mate_guessLng": ["p4_guessLng", "player_opponent_mate_guessLng"],
    "player_opponent_mate_score": ["p4_score", "player_opponent_mate_score"],
    "player_opponent_mate_isBestGuess": ["p4_isBestGuess", "player_opponent_mate_isBestGuess"],
    "distanceKm": ["player_self_distanceKm", "p1_distanceKm", "distanceKm"],
    "durationSeconds": ["durationSeconds", "guessDurationSec", "timeSec"]
  },

  "drilldownPresets": {
    "rounds": {
      "entity": "round",
      "columnsPresets": {
        "roundMode": [
          { "key": "ts", "label": "Date", "sortable": true },
          { "key": "result", "label": "Result", "sortable": true, "colored": true },
          { "key": "roundNumber", "label": "Round", "sortable": true },
          { "key": "player_self_score", "label": "Score", "sortable": true },
          { "key": "true_country", "label": "Country", "sortable": true },
          { "key": "durationSeconds", "label": "Guess Duration", "sortable": true },
          { "key": "damage", "label": "Damage", "sortable": true, "colored": true },
          { "key": "teammateName", "label": "Mate", "sortable": true },
          { "key": "gameId", "label": "Game", "sortable": true, "display": { "truncate": true, "truncateHead": 8 } },
          { "key": "guess_maps", "label": "Guess Maps", "type": "link", "link": { "kind": "guess_maps", "label": "Open" } },
          { "key": "street_view", "label": "True Street View", "type": "link", "link": { "kind": "street_view", "label": "Open" } }
        ]
      },
      "defaultPreset": "roundMode"
    },
    "players": {
      "entity": "game",
      "columnsPresets": {
        "opponentMode": [
          "ts",
          "gameId",
          "opponentName",
          "game_mode",
          "player_self_startRating",
          "player_self_endRating",
          "result"
        ]
      },
      "defaultPreset": "opponentMode"
    }
  },

  "errors": {
    "E_GRAIN_MISMATCH": "Selected fields have incompatible grains.",
    "E_CHART_X_NOT_ORDERED": "Line charts require an ordered x-dimension.",
    "E_SELECTOR_REQUIRED": "This dimension requires a selector (Top-N or Selected).",
    "E_TOO_MANY_SERIES": "Too many series requested; reduce categories or use selector."
  }
}
